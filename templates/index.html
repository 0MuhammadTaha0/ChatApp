<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/styles.css">
    <title>ChatApp: Dashboard</title>
  </head>
  <body>
    {% if get_flashed_messages() %}
            <header id="hideMe">
                <div class="alert alert-primary mb-0 text-center" role="alert">
                    {{ get_flashed_messages() | join(" ") }}
                </div>
            </header>
    {% endif %}
    <main>
        <div class="mycontainer">
            <div class="sidebar">
                <button class="icon">C</button>
                <button class="icon">G</button>
                <button class="icon">F</button>
                <button class="icon">⚙</button>
                <button class="icon">L</button>
            </div>
            
            <div class="contacts-section">
                <!-- Contacts or conversation list will appear here -->
            </div>
        
            <div class="chat-section">
                <div class="chat-header">
                    <!-- Profile picture or header icon -->
                    <span class="profile-icon"></span>
                    <span class="profile-name"><p></p></span>
                </div>
                <div class="chat-messages">
                    <!-- Messages will appear here -->
                </div>
                <form class="chat-input">
                    <input required type="text" placeholder="Type a message...">
                    <button type="submit" class="send-button">▶</button>
                </form>
            </div>
        </div>
    </main>
    
    <script>
        const chatInputForm = document.querySelector('.chat-input')
        function clickableContacts(contacts) {
            //Making contacts clickable and updating chat header
            const contact = document.querySelectorAll('.contact')
        
            for (let i = 0; i < contact.length; i++) {
                contact[i].addEventListener('click', function() {
                    const chatHeader = document.querySelector('.profile-name')
                    for (let j = 0; j < contact.length; j++) {
                        contact[j].style.backgroundColor = 'white';
                    }
                    contact[i].style.backgroundColor = '#D3D3D3';
                    let contactName = contact[i].innerHTML;
                    chatHeader.innerHTML = contactName;
                
                    const chatMessagesContainer = document.querySelector('.chat-messages');
                    chatMessagesContainer.innerHTML = '';

                    // Load messages (for now we assume these are already available in the contacts initial data)
                    for (let i = 0; i < contacts.length; i++) {
                        if (contacts[i]["username"] === contactName) {
                            if ('messages' in contacts[i]) {
                                const messages = contacts[i]["messages"];

                                // Append the messages
                                messages.forEach(function(message) {
                                    const messageDiv = document.createElement('div');
                                    messageDiv.classList.add('message');
                                    messageDiv.textContent = message["message"];
                                    chatMessagesContainer.appendChild(messageDiv);
                                });

                                // Scroll to the bottom of the chat
                                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                            }
                        }
                    }
                });
            }
        }

        const sendMessage = (e) => {
            e.preventDefault()
            const input = document.querySelector('.chat-input input');
            const message = input.value.trim();

            if (message) {
                const chatMessages = document.querySelector('.chat-messages');
                const newMessage = document.createElement('div');
                newMessage.classList.add('message');
                newMessage.textContent = message;
                chatMessages.appendChild(newMessage);
                input.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
            }
        }

        chatInputForm.addEventListener('submit', sendMessage)

        //Implementing icons
        const icons = document.querySelectorAll('.icon')

        icons[2].onclick = function(){
        location.href='/friends/add';
        };

        icons[3].onclick = function(){
        location.href='/settings';
        };

        icons[4].onclick = function(){
        location.href='/logout';
        };

        async function loadContacts() {
        const contactSectionContainer = document.querySelector('.contacts-section');
        let response = await fetch('/fetchContacts');
        if (response.status == 204) {
            // a little help from ChatGPT for creating new contact div
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('contact');
            messageDiv.innerHTML = `<a href="/friends/add">Click</a> to add friends!`;
            contactSectionContainer.appendChild(messageDiv);
        } else {
            let data = await response.json();
            data.forEach(element => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('contact');
            messageDiv.textContent = element["username"];
            contactSectionContainer.appendChild(messageDiv);
            });
            clickableContacts(data);
        }
        }

        loadContacts();
        
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>